<%
    // Logika EJS: Dapatkan tanggal hari ini dalam format YYYY-MM-DD untuk constraint MAX
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayFormatted = `${yyyy}-${mm}-${dd}`;
%>

<%- include('partials/header', { title: "Form Kehilangan | Lost & Found UMY", activePage: "layanan-mandiri" }) %>

<div class="bg-umygreen text-white py-8">
    <div class="container mx-auto px-6">
        <h1 class="text-3xl font-bold">Lapor Kehilangan Barang</h1>
        <p class="text-yellow-300 mt-2">Laporkan barang yang hilang di area kampus UMY.</p>
    </div>
</div>

<main class="container mx-auto px-6 py-10 max-w-4xl">
    
    <div class="bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        
        <form action="/submit-kehilangan" method="POST" enctype="multipart/form-data">
            
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Identitas Pelapor</h2>

            <div class="mb-6">
                <label class="block text-gray-700 font-bold mb-2">Nama<span class="text-umyred">*</span> <span class="font-normal text-sm text-gray-500">(Hanya huruf, max 50 karakter)</span></label>
                <input type="text" name="reporter_name" required maxlength="50" 
                    oninput="this.value = this.value.replace(/[^a-zA-Z\s]/g, '')"
                    class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen transition"
                    placeholder="Masukkan nama lengkap Anda">
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-bold mb-2">Status Pelapor<span class="text-umyred">*</span></label>
                <div class="bg-gray-100 p-4 rounded border border-gray-300 grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reporter_status" value="mahasiswa" class="form-radio text-umygreen h-5 w-5" checked onchange="updateIdentityRules()">
                        <span>Mahasiswa</span>
                    </label>

                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reporter_status" value="dosen" class="form-radio text-umygreen h-5 w-5" onchange="updateIdentityRules()">
                        <span>Dosen</span>
                    </label>

                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reporter_status" value="tendik" class="form-radio text-umygreen h-5 w-5" onchange="updateIdentityRules()">
                        <span>Tenaga Kependidikan</span>
                    </label>

                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reporter_status" value="foreign_student" class="form-radio text-umygreen h-5 w-5" onchange="updateIdentityRules()">
                        <span>Foreign Student</span>
                    </label>

                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="radio" name="reporter_status" value="lainnya" class="form-radio text-umygreen h-5 w-5" onchange="updateIdentityRules()">
                        <span>Lainnya (Umum/Tamu)</span>
                    </label>
                </div>
            </div>

            <div class="mb-8">
                <label id="label-identitas" class="block text-gray-700 font-bold mb-2">NIM<span class="text-umyred">*</span> (11 Digit Angka)</label>
                <input type="text" name="identification_number" id="input-identitas" required
                    class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen transition"
                    placeholder="Masukkan Nomor Induk Mahasiswa Anda">
            </div>


            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 pt-4">Data Barang Kehilangan</h2>

            <div class="mb-6">
                <label class="block text-gray-700 font-bold mb-2">Kategori Barang<span class="text-umyred">*</span></label>
                <div class="relative">
                    <select name="category_id" required class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 appearance-none focus:outline-none focus:bg-white focus:border-umygreen cursor-pointer">
                        <option value="" disabled selected>Pilih Kategori Barang</option>
                        <% categories.forEach(function(cat) { %>
                            <option value="<%= cat.id %>"><%= cat.name %></option>
                        <% }); %>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-700">
                        <i class="ri-arrow-down-s-line"></i>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-bold mb-2">Nama Barang<span class="text-umyred">*</span> <span class="font-normal text-sm text-gray-500">(Max 100 karakter)</span></label>
                <input type="text" name="item_name" required maxlength="100"
                    class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen"
                    placeholder="Contoh: Dompet kulit coklat, HP Samsung A51">
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-bold mb-2">Deskripsi Detail<span class="text-umyred">*</span></label>
                <textarea name="description" rows="4" required
                    class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen"
                    placeholder="Jelaskan ciri-ciri khusus barang yang hilang, seperti warna, merek, adanya stiker, atau detail lain."></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Tanggal Kehilangan<span class="text-umyred">*</span></label>
                    <input type="date" name="date_event" required
                        max="<%= todayFormatted %>" 
                        class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen">
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Lokasi Kehilangan<span class="text-umyred">*</span></label>
                    <input type="text" name="location" required
                        class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen"
                        placeholder="Contoh: Area parkir utara, Ruang B201, Kantin Fikes">
                </div>
            </div>

            <div class="mb-8">
                <label class="block text-gray-700 font-bold mb-2">Foto Barang (Opsional)</label>
                <div class="flex items-center justify-center w-full">
                    
                    <label for="dropzone-file-lost" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition overflow-hidden relative p-4">
                        
                        <div id="upload-placeholder-lost" class="flex flex-col items-center justify-center pt-5 pb-6 text-center w-full">
                            <i class="ri-upload-cloud-2-line text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-500"><span class="font-semibold">Klik di sini untuk unggah foto</span></p>
                            <p class="text-xs text-gray-400 mt-1">PNG, JPG, JPEG (Max. 2MB)</p>
                        </div>
                        
                        <div id="file-preview-area-lost" class="hidden absolute inset-0 flex flex-col justify-between w-full h-full bg-white p-3">
                            
                            <div class="flex justify-center flex-grow items-center overflow-hidden border border-gray-200 rounded-lg">
                                <img id="image-preview-lost" src="#" alt="Preview" class="max-w-full max-h-full object-contain">
                            </div>

                            <div class="flex justify-between items-center mt-2">
                                <div>
                                    <p id="file-name-lost" class="text-sm font-semibold text-gray-800 truncate w-32"></p>
                                    <p class="text-xs text-gray-400">PNG, JPG, JPEG (Max. 2MB)</p>
                                </div>
                                <button type="button" id="clear-file-btn-lost" class="text-red-500 hover:text-red-700 transition" onclick="clearFileLost('dropzone-file-lost', 'image-preview-lost', 'upload-placeholder-lost', 'file-preview-area-lost', 'file-name-lost')">
                                    <i class="ri-close-circle-fill text-2xl"></i>
                                </button>
                            </div>
                        </div>

                        <input id="dropzone-file-lost" name="item_image" type="file" class="hidden" accept="image/png, image/jpeg, image/jpg" onchange="previewImageLost(event, 'image-preview-lost', 'upload-placeholder-lost', 'file-preview-area-lost', 'file-name-lost')" />
                    </label>
                </div>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 pt-4">Verifikasi Kontak</h2>

            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Email Aktif<span class="text-umyred">*</span> <span class="font-normal text-sm text-gray-500">(Wajib @gmail.com)</span></label>
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="email" id="input-email-lost" name="reporter_email" required
                        class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen"
                        placeholder="email@gmail.com">
                    
                    <button type="button" onclick="validateEmailLost()"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded border border-gray-300 transition whitespace-nowrap">
                        Kirim Kode
                    </button>
                </div>
                <p id="email-error-msg-lost" class="text-red-600 text-sm font-bold mt-2 hidden"></p>
                <p id="email-success-msg-lost" class="text-green-600 text-sm font-bold mt-2 hidden"></p>
            </div>

            <div class="mb-10">
                <label class="block text-gray-700 font-bold mb-2">Kode OTP</label>
                <div class="flex gap-2">
                    <input type="text" id="input-otp-lost" name="otp_code" maxlength="6" 
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                        class="w-full bg-gray-100 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:bg-white focus:border-umygreen"
                        placeholder="Masukkan kode 6 digit">
                    
                    <button type="button" onclick="cekKodeOtpLost()"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded border border-gray-300 transition whitespace-nowrap">
                        Verifikasi
                    </button>
                </div>
                <p id="otp-msg-lost" class="text-sm font-bold mt-2 hidden"></p>
            </div>

            <div class="flex flex-col-reverse md:flex-row justify-end gap-4">
                <a href="/" class="text-center w-full md:w-auto bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-8 rounded shadow transition">
                    Batal
                </a>
                <button type="submit" class="w-full md:w-auto bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-8 rounded shadow transition">
                    Laporkan Kehilangan
                </button>
            </div>

        </form>
    </div>
</main>

<script>
    // 1. FUNGSI UTILITY CLEAR FILE (UNTUK KEHILANGAN)
    function clearFileLost(inputId, previewId, placeholderId, previewAreaId, fileNameId) {
        const input = document.getElementById(inputId);
        const previewArea = document.getElementById(previewAreaId);
        const placeholder = document.getElementById(placeholderId);
        
        input.value = ''; // Mengosongkan input file
        previewArea.classList.add('hidden');
        placeholder.classList.remove('hidden');
        document.getElementById(fileNameId).innerText = '';
    }

    // 2. FUNGSI PREVIEW IMAGE (TERMASUK VALIDASI UKURAN 2MB - UNTUK KEHILANGAN)
    function previewImageLost(event, previewId, placeholderId, previewAreaId, fileNameId) {
        const input = event.target;
        const preview = document.getElementById(previewId);
        const placeholder = document.getElementById(placeholderId);
        const previewArea = document.getElementById(previewAreaId);
        const fileNameElement = document.getElementById(fileNameId);
        const maxFileSize = 2 * 1024 * 1024; // 2 MB dalam bytes

        if (input.files && input.files[0]) {
            const file = input.files[0];

            // Cek Ukuran File
            if (file.size > maxFileSize) {
                alert('Ukuran file melebihi batas maksimum 2MB.');
                clearFileLost(input.id, previewId, placeholderId, previewAreaId, fileNameId); // Clear input
                return;
            }

            // Tampilkan Preview dan Nama File
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                fileNameElement.innerText = file.name;
                placeholder.classList.add('hidden');
                previewArea.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        } else {
            // Jika file di-clear secara manual
            clearFileLost(input.id, previewId, placeholderId, previewAreaId, fileNameId);
        }
    }

    // 3. Validasi Identitas
    function updateIdentityRules() {
        const status = document.querySelector('input[name="reporter_status"]:checked').value;
        const label = document.getElementById('label-identitas');
        const input = document.getElementById('input-identitas');

        input.value = ""; 
        input.removeAttribute('maxlength');
        input.removeAttribute('oninput');

        if (status === 'mahasiswa') {
            label.innerHTML = 'NIM<span class="text-umyred">*</span> (11 Digit Angka)'; 
            input.placeholder = 'Contoh: 20210140001';
            input.maxLength = 11;
            input.setAttribute('oninput', "this.value = this.value.replace(/[^0-9]/g, '')");
        } else if (status === 'dosen' || status === 'tendik') {
            label.innerHTML = 'NIP / NIK<span class="text-umyred">*</span>'; 
            input.placeholder = 'Masukkan Nomor Induk Pegawai';
            input.maxLength = 20;
            input.setAttribute('oninput', "this.value = this.value.replace(/[^0-9]/g, '')");
        } else if (status === 'foreign_student') {
            label.innerHTML = 'Passport Number<span class="text-umyred">*</span>'; 
            input.placeholder = 'Enter your Passport Number';
            input.maxLength = 20;
        } else {
            label.innerHTML = 'Nomor KTP / NIK<span class="text-umyred">*</span> (16 Digit)'; 
            input.placeholder = 'Masukkan 16 digit NIK KTP';
            input.maxLength = 16;
            input.setAttribute('oninput', "this.value = this.value.replace(/[^0-9]/g, '')");
        }
    }

    // 4. Kirim Kode OTP (Pesan Debug untuk Beta)
    function validateEmailLost() {
        const emailInput = document.getElementById('input-email-lost');
        const errorMsg = document.getElementById('email-error-msg-lost');
        const successMsg = document.getElementById('email-success-msg-lost');
        const email = emailInput.value;
        const gmailRegex = /.+@gmail\.com$/;

        errorMsg.classList.add('hidden');
        successMsg.classList.add('hidden');
        emailInput.classList.remove('border-red-500', 'border-green-500');

        if (!gmailRegex.test(email)) {
            errorMsg.innerText = "Error: Email wajib menggunakan @gmail.com!";
            errorMsg.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
            return;
        }

        fetch('/api/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // PESAN DEBUGGING UNTUK TAHAP BETA
                successMsg.innerHTML = 'Kode verifikasi berhasil dibuat. <span class="text-blue-600 font-bold">Cek terminal server Anda.</span>';
                successMsg.classList.remove('hidden');
                emailInput.classList.add('border-green-500');
            } else {
                errorMsg.innerText = "Gagal: " + data.message;
                errorMsg.classList.remove('hidden');
            }
        })
        .catch(err => console.error(err));
    }

    // 5. Cek OTP
    function cekKodeOtpLost() {
        const email = document.getElementById('input-email-lost').value;
        const otp = document.getElementById('input-otp-lost').value;
        const msg = document.getElementById('otp-msg-lost');
        const inputOtp = document.getElementById('input-otp-lost');

        if(!email || !otp) {
            alert("Harap isi Email dan Kode OTP terlebih dahulu!");
            return;
        }

        fetch('/api/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, otp_code: otp })
        })
        .then(res => res.json())
        .then(data => {
            msg.classList.remove('hidden', 'text-red-600', 'text-green-600');
            
            if (data.success) {
                msg.innerText = "✅ Kode Valid! Silakan lanjutkan laporan.";
                msg.classList.add('text-green-600');
                inputOtp.classList.add('border-green-500', 'bg-green-50');
                inputOtp.classList.remove('border-red-500');
            } else {
                msg.innerText = "❌ " + data.message;
                msg.classList.add('text-red-600');
                inputOtp.classList.add('border-red-500');
            }
        })
        .catch(err => console.error(err));
    }

    document.addEventListener("DOMContentLoaded", function() {
        updateIdentityRules();
    });
</script>

<%- include('partials/footer') %>